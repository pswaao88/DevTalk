# ADR-011: 저장 계층 단계적 전환 전략 (In-Memory → SQL → JPA)

## 상태
Accepted

## 결정 시점
- 2026-01-04
- 적용 회차: 3회차 ~ 5회차

## 배경

WarruruLab / DevTalk은 다음과 같은 전제를 가진다.

- 기록과 판단의 **의미**가 프로젝트의 핵심이다.
- 저장 기술은 회차별로 단계적으로 발전한다.
  - 3회차: in-memory(Map) 기반
  - 중간 단계: SQL 직접 작성(JDBC)
  - 5회차 이후: JPA 기반 영속화
- 저장 방식은 바뀌어도 **API 계약, Service의 기록 규칙, Domain의 의미는 유지**되어야 한다.

기존에 사용하던 방식인 entity 패키지에 entity 두고 바로 JPA 사용은 초기 개발 속도는 빠르지만,  
저장 기술 변화(in-memory → SQL → JPA)와 기록 중심 철학을 구조로 강제하기 어렵다는 문제가 있다.

따라서 “무엇을 고정하고, 무엇을 교체할 것인지”에 대한 명확한 판단이 필요했다.

---

## 결정

### 고려한 선택지 (Options)

### 옵션 A: Domain = JPA Entity (기존 방식: 기존에는 entity이름이었지만 domain과 동일한 역할)

- domain 패키지에 `@Entity` 사용
- Spring Data JPA 직접 사용

**장점**

- 구현이 단순
- 매핑 코드 없음

**단점**

- domain이 JPA/DB 제약에 종속됨
- in-memory, SQL 직접 단계와의 연결이 어색함
- 저장 기술 변경 시 Service/Domain 수정 가능성 큼

---

### 옵션 B: Domain ↔ 저장 기술 분리 (Repository 인터페이스 + 구현체 교체)

- Domain은 순수 모델 유지
- Repository는 인터페이스로 고정
- 저장 방식은 infra 구현체로 단계별 교체
  - InMemory → JDBC → JPA

**장점**

- 저장 기술 교체 비용 최소화
- 기록/판단 규칙(Service, Domain) 보호
- 회차 로드맵과 자연스럽게 연결됨

**단점**

- Mapper/Adapter 코드 증가
- 초기 구조가 다소 복잡

---

**옵션 B를 채택한다.**

- Domain은 저장 기술과 분리된 **의미 중심 모델**로 유지한다.
- Service는 Repository 인터페이스에만 의존한다.
- 저장 방식은 infra 계층에서 단계적으로 교체한다.
  - 3회차: InMemory Repository
  - 중간 단계: JDBC 기반 SQL Repository
  - 5회차 이후: JPA Repository

---

## 이유

1. **회차 로드맵과 정확히 맞는다**

   - 저장 기술만 교체하고, 나머지는 그대로 두는 구조가 필요했다.

2. **기록/판단 중심 철학을 구조로 강제할 수 있다**

   - Service와 Domain이 JPA에 제약되지 않는다.
   - “실패도 기록한다”, “Resolved는 사람의 선언” 같은 규칙이 저장 기술과 무관하게 유지된다.

3. **변경의 영향 범위를 명확히 제한할 수 있다**

   - 저장 방식 변경 → infra 구현체만 수정
   - 판단 규칙 변경 → domain/service만 수정

4. **테스트와 회고에 유리하다**
   - Domain/Service는 DB 없이도 테스트 가능
   - 회고 시 “왜 이 규칙이 여기 있는지” 설명 가능

---

## 단계별 구현 원칙 (Consequences)

### 3회차: In-Memory 단계

- Repository 인터페이스는 최종 형태처럼 설계
- 구현체만 Map 기반
- Service/Controller는 DB 존재를 모름

### SQL 직접 단계

- JDBC/JdbcTemplate/MyBatis 등으로 Repository 구현체 교체
- SQL 결과를 Domain으로 매핑
- Service 코드 변경 없음이 목표

### JPA 단계

- Repository 구현체를 JPA 기반으로 교체
- 가능하면 Domain ↔ JPA Entity 분리 유지
- 속도가 필요하면 Domain=Entity로 합치는 타협 가능  
  → 단, 이 경우 **ADR로 별도 기록**

---

## 결과

### 긍정적 효과

- 저장 기술 변화에도 핵심 로직 안정
- 기록 구조가 기술 제약에 흔들리지 않음
- ProblemWarruru(로그 → 글)로 확장하기 쉬움

### 감수하는 비용

- Mapper/Adapter 코드 증가
- 초기 학습 비용 및 구조 복잡성 증가

### 향후 변경 가능성

- JPA 단계에서 Domain=Entity로 합치는 타협 가능
- 해당 변경은 **새 ADR로 관리**
