# ADR-017: DevTalk 세션 요약 전략으로 누적 요약 방식 채택

## 상태
Accepted

## 결정 시점
2026-01-20

## 배경
DevTalk의 컨텍스트 구성 방식을 최근 메세지 8000자에서 요약 + N개의 메세지로 변경했다.
현재의 관점에서 어떻게 요약을 해야할지에 대한 고민이 있었다.
생각한 방식은 다음의 두가지 이다.

1. 기존 요약 정보와 새로 추가된 메시지를 함께 사용해  
   하나의 요약문을 갱신하는 방식
2. tail(N개의 메시지) 중 앞부분을 요약해 요약문에 누적하는 방식

## 결정
1번 방식으로 관리하기로 했다.

- 세션별로 요약문과 **요약 진행 지점**을 함께 저장한다.
- 요약 업데이트 시,  
  **아직 요약에 반영되지 않은 대화 구간** 중  
  최신 tail을 제외한 부분만을 LLM에 전달해 요약을 갱신한다.
- 요약 생성은 매 요청마다 수행하지 않고, 필요 시점에만 수행한다.
- 요약문은 **운영 컨텍스트 안정성을 위해 길이 제한을 둔다.**
    - 요약 생성 프롬프트에는 **“1000자 이내로 작성”** 조건을 포함한다.
    - 서버에서는 모델 오차를 고려해 **약간의 여유를 둔 상한선**을 적용하고,
      이를 초과할 경우 재압축 요약을 수행한다.
  
## 이유
- 요약 생성 시 입력으로 전달되는 내용이  
  항상 **새로 추가된 대화 구간**으로 제한되어
    - LLM 입력 크기가 안정적으로 유지된다.
    - 응답 지연 및 UNKNOWN 발생 확률이 낮아진다.
- 요약 반영 범위가 명확히 관리되어
    - 어떤 대화가 요약에 포함되었는지 예측 가능하다.
    - 반복 요약으로 인한 품질 저하를 방지할 수 있다.
- 요약 생성 실패 시에도 상태를 유지하고 기록만 남길 수 있어,
  DevTalk의 “실패도 기록 자산” 원칙을 유지할 수 있다.

## 결과
- DevTalk의 컨텍스트 구성은 더 이상 문자열 길이 기준에 의존하지 않는다.
- 세션이 길어져도 컨텍스트 크기와 응답 품질이 안정적으로 유지된다.
- 요약 생성은 독립된 유스케이스로 분리되어,
  응답 생성 로직과 명확히 분리된 구조를 갖는다.
